name: CI/CD for React and SpringBoot

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4.2.2

      - name: Install Node.js (for React)
        uses: actions/setup-node@v4.3.0
        with:
          node-version: 18.x

      - name: Install React Dependencies
        run: |
          echo "Navigating to client directory to install dependencies..."
          cd client
          npm install
          echo "React dependencies installed."

      - name: Build React Project
        run: |
          echo "Navigating to client directory to build React project..."
          cd client
          CI=false npm run build
          echo "React project built successfully."

      - name: Copy React build files to Spring Boot static directory
        run: |
          echo "Copying React build files to Spring Boot static directory..."
          cd $GITHUB_WORKSPACE
          mkdir -p ./rest/src/main/resources/static/
          cp -r ./client/build/* ./rest/src/main/resources/static/
          echo "React build files copied."

      - name: Set up JDK (for Spring Boot)
        uses: actions/setup-java@v4.7.0
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Make mvnw executable
        run: |
          echo "Making mvnw executable..."
          chmod +x rest/mvnw
          echo "mvnw is executable."

      - name: Build and Package Spring Boot project (with React files)
        run: |
          echo "Navigating to rest directory to build and package Spring Boot project..."
          cd rest
          ./mvnw clean install -DskipTests
          echo "Spring Boot project built and packaged successfully."

      - name: Upload Spring Boot JAR artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: spring-boot-app
          path: ./rest/target/*.jar
          # The JAR name might vary based on your project's pom.xml.
          # For example, if your JAR is named 'my-app-0.0.1-SNAPSHOT.jar',
          # ensure SPRING_BOOT_JAR_NAME secret matches this.
          # This step will upload the JAR found in target/.

  deploy-to-azure-vm:
    runs-on: ubuntu-latest
    needs: build-and-package
    environment: production
    steps:
      - name: Download Spring Boot JAR artifact
        uses: actions/download-artifact@v4.1.4
        with:
          name: spring-boot-app
          path: ./
        # This will download the JAR into the root of the current runner's workspace.
        # Example: if the artifact was 'my-app-0.0.1-SNAPSHOT.jar', it will be at './my-app-0.0.1-SNAPSHOT.jar'

      - name: Set JAR filename (assuming only one JAR is downloaded)
        id: get_jar_name
        run: |
          JAR_FILE=$(find . -name "*.jar" -print -quit)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: No JAR file found after downloading artifact."
            exit 1
          fi
          echo "Detected JAR file: $JAR_FILE"
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Deploy to Azure VM via SSH and SCP
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          script: |
            set -e # Exit immediately if a command exits with a non-zero status.

            JAR_NAME="${{ steps.get_jar_name.outputs.jar_name }}"
            TARGET_DIR="${{ secrets.AZURE_VM_TARGET_DIR }}"
            SERVICE_NAME="springboot.service" # Or whatever your systemd service is named

            echo "Starting deployment to Azure VM..."
            echo "Target directory: $TARGET_DIR"
            echo "JAR file to deploy: $JAR_NAME"

            # Check if the target directory exists, create if not
            if [ ! -d "$TARGET_DIR" ]; then
              echo "Target directory $TARGET_DIR does not exist. Creating it."
              mkdir -p "$TARGET_DIR"
            fi

            echo "Copying JAR file to VM using SCP..."
            # Use scp to copy the JAR from the GitHub Actions runner to the VM
            # The JAR is in the current directory (./) of the runner after download-artifact
            scp "$JAR_NAME" "$TARGET_DIR/$JAR_NAME"
            echo "JAR file copied successfully to $TARGET_DIR/$JAR_NAME."

            echo "Navigating to target directory on VM: $TARGET_DIR"
            cd "$TARGET_DIR" || { echo "Failed to change directory to $TARGET_DIR"; exit 1; }

            echo "Stopping existing Spring Boot service ($SERVICE_NAME)..."
            sudo systemctl stop "$SERVICE_NAME" || echo "Service $SERVICE_NAME was not running or failed to stop, continuing..."

            echo "Starting Spring Boot service ($SERVICE_NAME)..."
            sudo systemctl start "$SERVICE_NAME"
            echo "Service start command issued. Checking status..."

            # Give it a moment to start and check status
            sleep 5
            sudo systemctl status "$SERVICE_NAME" --no-pager || { echo "Failed to get service status. Check VM logs manually."; exit 1; }

            echo "Deployment complete. Check application logs on VM for full status."
            echo "You can check logs using: journalctl -u $SERVICE_NAME -f"
